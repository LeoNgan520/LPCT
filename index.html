<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MNHC Pricing Tool (Offline) v0.3.28</title>
  <style>
    :root{ --bg:#f7f5ef; --panel:#ffffff; --edge:#e7e3d9; --text:#1a1f2a; --muted:#5f6b7a; --accent:#856a52; --accent-2:#b79273; --warn:#b45309; --ok:#166534; --red:#b91c1c; --mode-nong:#fde2e4; --mode-jiu:#e7f5e9 }
    *,*:before,*:after{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", Ubuntu, "Helvetica Neue", Arial}
    .wrap{max-width:1100px;margin:16px auto;padding:0 12px}

    .toolbar{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:flex-end;margin-bottom:8px}
    .toolbar-left{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .toolbar-right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .choose{padding:6px 8px;border:1px solid var(--edge);border-radius:10px;background:#fff}
    .modeSelect{padding:6px 8px;border:1px solid var(--edge);border-radius:10px;min-width:150px}
    .mode-nong{background:var(--mode-nong)!important}
    .mode-jiu{background:var(--mode-jiu)!important}
    #loadStatus{margin-left:6px;font-size:12px;color:#5f6b7a}

    .disc{display:flex;gap:8px;align-items:center}
    .disc .field{display:flex;align-items:center;gap:6px}
    .disc label{font-size:12px;color:var(--muted);margin:0}
    .disc input{width:78px;padding:6px 8px;border:1px solid var(--edge);border-radius:8px}

    .card{background:var(--panel);border:1px solid var(--edge);border-radius:16px;padding:14px;margin:10px 0;box-shadow:0 3px 14px rgba(0,0,0,.04)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-start}
    .col{flex:1 1 320px;min-width:280px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select,textarea,button{background:#fff;color:#1f2937;border:1px solid var(--edge);border-radius:10px;padding:10px}
    textarea{min-height:140px;width:100%}
    .btn{cursor:pointer;background:var(--accent);border:1px solid var(--accent);color:#fff;padding:8px 12px;border-radius:10px}
    .btn:hover{background:var(--accent-2);border-color:var(--accent-2)}
    .btn.ghost{background:#fff;color:var(--accent);border-color:var(--accent)}
    .btn.warn{background:#fff;color:var(--warn);border-color:var(--warn)}
    .btn.ok{background:#fff;color:var(--ok);border-color:var(--ok)}
    .xbtn{background:#fff;border:1px solid var(--red);color:#b91c1c;border-radius:8px;line-height:1;padding:2px 8px}

    .grid{overflow:auto;border:1px solid var(--edge);border-radius:12px}
    table{border-collapse:collapse;width:100%;min-width:760px;background:#fff}
    th,td{border-bottom:1px solid var(--edge);padding:8px;vertical-align:middle}
    th{position:sticky;top:0;background:#faf8f2;white-space:nowrap}
    td{white-space:nowrap}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .banner{margin-top:8px;padding:8px 10px;border:1px dashed var(--warn);background:#fff5e8;border-radius:10px;color:#7c3e05}

    th.c-del,  td.c-del  {width:40px;text-align:left}
    th.c-code, td.c-code {width:110px;text-align:left}
    th.c-name, td.c-name { text-align:center; width:auto; min-width:72px; max-width:clamp(80px,14vw,140px); text-overflow:ellipsis; overflow:hidden }
    th.c-qty,  td.c-qty  {width:70px;text-align:left}
    th.c-free, td.c-free {width:40px;text-align:left}
    th.c-unit, td.c-unit {width:86px;text-align:left}
    th.c-retail, td.c-retail {width:86px;text-align:left}
    th.c-disc, td.c-disc {width:96px;text-align:left}
    th.c-sub,  td.c-sub  {width:110px;text-align:right}

    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0 }
    input[type=number]{ -moz-appearance:textfield }

    .sortable{cursor:pointer;user-select:none}
    .sortable .arrow{font-size:10px;margin-left:4px;opacity:.6}

    @media (max-width:600px){ th,td{padding:6px;font-size:13px} .col{min-width:240px} }

    .hint{font-size:12px;color:var(--muted)}
    .suggest{margin-top:8px;border:1px solid var(--edge);border-radius:10px;padding:8px;background:#fff}
    .suggest h4{margin:0 0 6px;font-size:12px;color:#6b7280}
    .suglist{font-size:12px;color:#444;display:grid;grid-template-columns:1fr;gap:4px;white-space:nowrap}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="toolbar">
      <div class="toolbar-left">
        <div class="disc" id="discounts"></div>
      </div>
      <div class="toolbar-right">
        <input id="csvFile" class="choose" type="file" accept=".csv" title="載入本地 CSV" />
        <span id="loadStatus" class="muted"></span>
        <select id="mode" class="modeSelect mode-jiu" title="選擇模式">
          <option value="nong">農本方</option>
          <option value="jiu" selected>零售</option>
        </select>
        <button id="btnCompact" class="btn ghost" type="button" title="切換緊湊模式">緊湊模式</button>
      </div>
    </div>

    <!-- 訂單區 -->
    <div class="card">
      <div class="row" style="align-items:center;justify-content:space-between">
        <div class="row" style="gap:8px">
          <button id="btnTranslate" class="btn ghost" type="button">譯單</button>
          <button id="btnCopyQuote" class="btn ghost" type="button">報價</button>
        </div>
        <button id="btnClearAll" class="btn warn" type="button">清空全部</button>
      </div>
      <div id="nongBanner" class="banner" style="display:none">農本方提示：折實後未滿 800。</div>

      <div class="grid" style="margin-top:8px">
        <table id="resultTbl">
          <thead>
            <tr id="theadRow">
              <th class="c-del"></th>
              <th id="thCode" class="c-code sortable">產品編號<span class="arrow" id="codeArrow">↕</span></th>
              <th class="c-name">產品名稱</th>
              <th class="c-qty">數量</th>
              <th class="c-free" title="不計費">免</th>
              <th id="thUnit" class="c-unit">價格</th>
              <th id="thRetail" class="c-retail" style="display:none">零售價</th>
              <th id="thDisc" class="c-disc sortable">折實價<span class="arrow" id="discArrow">↕</span></th>
              <th class="c-sub">小計</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <th colspan="6" style="text-align:left">合計</th>
              <th class="right" id="grandTotal" colspan="1">$0</th>
              <th></th>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="mini" id="orderBadge" style="margin-top:6px;color:#5f6b7a">
        此訂單的折扣：— ｜ 單味 0 枝；複方 0 枝；總 0 枝
      </div>
    </div>

    <!-- 落單內容 -->
    <div class="card">
      <div class="row">
        <div class="col">
          <label>落單內容</label>
          <textarea id="orderInput" placeholder="輸入 -> ENTER&#10;連接詞限：'.' 'x' '×' '*' '＊' ' '（空格）"></textarea>
          <div class="row" style="margin-top:8px;gap:8px;justify-content:space-between;align-items:center">
            <div style="display:flex;gap:8px;align-items:center">
              <button id="btnParseAdd" class="btn ok" type="button">加到訂單</button>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <button id="btnParseReplace" class="btn" type="button">取代訂單</button>
              <button id="btnClearInput" class="btn ghost" type="button">清空</button>
            </div>
          </div>
        </div>
        <div class="col">
          <div id="suggestBox" class="suggest" style="display:none">
            <h4>未能解析的項目（前 5 筆候選；若超過將顯示「……等等」）：</h4>
            <div id="suggestList" class="suglist"></div>
          </div>
        </div>
      </div>
    </div>

  </div>

<script>
// ===== Utilities =====
const $ = sel => document.querySelector(sel)
const $$ = sel => Array.from(document.querySelectorAll(sel))
const round0 = n => Math.round((+n||0))
const fmt2 = n => (isNaN(n)? '-' : '$'+Number(n).toFixed(2))
const fmt0 = n => (isNaN(n)? '-' : '$'+String(round0(n)))
const toNumber = s => { if (s==null) return NaN; const t=String(s).replace(/[\,\s]/g,''); return Number(t) }
const normalizeFullHalf = s => String(s).replace(/（/g,'(').replace(/）/g,')').replace(/[０-９]/g, d=> String.fromCharCode(d.charCodeAt(0)-0xFEE0)).trim()
const stripTailPunct = s => String(s).replace(/[。．\.|、，,：:；;]+$/g,'')
const normalizeCode = s => stripTailPunct(normalizeFullHalf(String(s))).replace(/[–—－﹣]/g,'-').trim()
const stripTrailingZero = x => String(x).replace(/\.0$/,'')
const normNameStrict = s => String(s).replace(/[\s·\.\-_/、，,；;:：\(\)\[\]{}「」『』“”"']/g,'')
const isSecure = () => window.isSecureContext === true
let qtyTimers = new Map()

function toast(msg){ alert(msg) }

// 折數顯示：80=>8、70=>7、100=>10，其餘維持原樣
function formatFold(p){ const n=Math.round(Number(p)||0); return (n>=10 && n%10===0) ? String(n/10) : String(n) }

// ===== CSV parse (RFC4180-ish) =====
function parseCSV(text){
  const rows=[]; let i=0, field='', row=[], inQ=false
  while(i<text.length){
    const c=text[i]
    if(inQ){ if(c==='"'){ if(text[i+1]==='"'){ field+='"'; i++ } else { inQ=false } } else { field+=c } }
    else{ if(c==='"'){ inQ=true } else if(c===','){ row.push(field); field='' } else if(c==='\n'){ row.push(field); rows.push(row); row=[]; field='' } else if(c==='\r'){ } else { field+=c } }
    i++
  }
  if(field.length>0 || row.length>0){ row.push(field); rows.push(row) }
  return rows
}

// ===== Header normalize =====
const HEADER_MAP = new Map([
  ['代碼','代碼'], ['產品編號','代碼'], ['編號','代碼'], ['code','代碼'], ['Code','代碼'],
  ['品名','品名'], ['產品名稱','品名'], ['名稱','品名'], ['name','品名'], ['Name','品名'],
  ['批發價','批發價'], ['參考零售價','參考零售價'], ['公價產品','公價產品'],
  ['濃度(倍)','濃度(倍)'], ['濃度（倍）','濃度(倍)'], ['濃度','濃度(倍)'],
  ['裝量','裝量'], ['裝量_g','裝量_g'],
  ['公價零售可折','公價零售可折']
])
function normalizeHeaders(cols){
  return cols.map(c=>{
    const key = normalizeFullHalf(c)
    if(HEADER_MAP.has(key)) return HEADER_MAP.get(key)
    for(const [k,v] of HEADER_MAP.entries()){
      if(k.toLowerCase()===key.toLowerCase()) return v
    }
    return key
  })
}
function parseGrams(v){
  if(v==null) return NaN
  const s=String(v).trim().toLowerCase()
  const m=s.match(/([\d.]+)\s*(g|克|kg|公斤)?/)
  if(!m) return NaN
  let val=parseFloat(m[1])
  const unit=m[2]||''
  if(unit==='kg' || unit==='公斤') val*=1000
  return val
}
function classify(code){
  const c=String(code||'').trim().toUpperCase()
  if(/^2/.test(c)) return '複方'
  if(/^FG-53(5[6-9]|6[0-5])$/.test(c)) return '複方'
  if(c==='6001' || c==='6002') return '複方'
  if(/^1/.test(c) || /^6/.test(c)){ if(c==='6005') return '單味'; return '單味' }
  return '單味'
}

// ===== State =====
let DB=[]
let MODE='jiu' // 顯示為零售
let cartItems=[] // {rec, qty, noCharge, seq}
let sortState = { key:'input', asc:true } // 預設按輸入次序
let nextSeq = 0 // 保留原始輸入順序
const CODE_COLLATOR = new Intl.Collator(undefined, {numeric:true, sensitivity:'base'})

// ===== Mode & discounts =====
function setModeBg(){
  const sel=document.getElementById('mode')
  sel?.classList.remove('mode-nong','mode-jiu')
  if(MODE==='nong') sel?.classList.add('mode-nong')
  else if(MODE==='jiu') sel?.classList.add('mode-jiu')
}
function renderDiscounts(){
  const box=document.getElementById('discounts')
  if(!box) return
  if(MODE==='nong'){
    box.innerHTML = '<div class="field"><label>單味</label><input id="dSingle" value="75" /></div>'+
                    '<div class="field"><label>複方</label><input id="dCombo" value="75" /></div>'
  }else{
    box.innerHTML = '<div class="field"><label>≤2枝折扣</label><input id="jiuDiscFew" value="80" /></div>'+
                    '<div class="field"><label>≥3枝折扣</label><input id="jiuDiscMany" value="66" /></div>'
  }
}
function readPercentInput(id, def){ const el=document.querySelector(id); if(!el) return def; const v = toNumber(el.value); return isNaN(v)? def : v }

document.getElementById('mode')?.addEventListener('change',e=>{
  MODE=e.target.value
  setModeBg(); renderDiscounts(); bindDiscountInputs(); renderTable(); updateInputTheme()
})

document.addEventListener('DOMContentLoaded', ()=>{
  try{
    const modeSel=document.getElementById('mode'); if(modeSel) modeSel.value='jiu'
    setModeBg(); renderDiscounts(); bindDiscountInputs(); renderTable(); updateInputTheme()
  }catch(err){ console.error('init error', err) }
})
document.getElementById('btnClearInput')?.addEventListener('click',()=>{ const ta=document.getElementById('orderInput'); if(ta) ta.value='' })

// ===== Load CSV =====
async function readFileAsText(file){
  if (file && typeof file.text === 'function') {
    try { return await file.text() } catch(e){}
  }
  return await new Promise((resolve, reject)=>{
    const fr = new FileReader()
    fr.onload  = () => resolve(String(fr.result||''))
    fr.onerror = () => reject(fr.error || new Error('read error'))
    fr.readAsText(file, 'utf-8')
  })
}
function updateLoadStatus(count, ok=true){
  const el = document.getElementById('loadStatus'); if(!el) return
  if(count==null){ el.textContent=''; return }
  el.textContent = ok ? `已載入：${count} 筆` : `載入失敗`
  el.style.color = ok ? '#5f6b7a' : '#b91c1c'
}
document.getElementById('csvFile')?.addEventListener('change', async (e)=>{
  const f = e.target?.files && e.target.files[0]
  if(!f){ updateLoadStatus(null); return }
  try{
    const text = await readFileAsText(f)
    const rows = parseCSV(text)
    if(!rows || rows.length===0){ updateLoadStatus(0,false); return }

    let header = rows[0].map(normalizeFullHalf)
    const generic = header.every(h=>/^Unnamed:|^$|^\d+$/.test(h))
    if(generic && rows.length>1){
      header = rows[1].map(normalizeFullHalf)
      rows.splice(0,2)
    }else{
      rows.splice(0,1)
    }

    const normHeader = normalizeHeaders(header)
    const idx = Object.fromEntries(normHeader.map((h,i)=>[h,i]))

    const yn = s => /^y/i.test(String(s||'').trim())

    DB = rows.map(r=>({
      代碼: String(r[idx['代碼']] ?? '').trim(),
      品名: String(r[idx['品名']] ?? '').trim(),
      批發價: toNumber(r[idx['批發價']]),
      參考零售價: toNumber(r[idx['參考零售價']]),
      公價產品: String(r[idx['公價產品']] ?? '').trim().toLowerCase()==='true'
            || String(r[idx['公價產品']] ?? '').trim()==='1'
            || /是|yes/i.test(String(r[idx['公價產品']] ?? '')),
      濃度倍: toNumber(r[idx['濃度(倍)']]) || 1,
      裝量: normalizeFullHalf(r[idx['裝量']] ?? ''),
      裝量_g: toNumber(r[idx['裝量_g']]) || parseGrams(r[idx['裝量']]),
      公價零售可折: yn(r[idx['公價零售可折']])
    })).filter(x=>x.代碼 || x.品名)

    updateLoadStatus(DB.length, true)
    renderTable()
  }catch(err){
    console.error(err)
    updateLoadStatus(0,false)
    alert('讀取 CSV 失敗，請重試或更換瀏覽器')
  }
})

// ===== Parser =====
function findByCode(token){ const key = normalizeCode(token).toUpperCase(); return DB.find(r=> normalizeCode(r.代碼).toUpperCase() === key ) }
function findByName(token){ const key = normNameStrict(token); return DB.find(r=> normNameStrict(r.品名) === key ) }
function parseLineStrict(lineRaw){
  const s0 = stripTailPunct(normalizeFullHalf(lineRaw)).trim()
  if(!s0) return null
  const tryPush = (rec, qty) => rec && !isNaN(qty) ? {rec, qty:Number(qty), noCharge:false} : null
  let m
  m = s0.match(/^(\S+)\s+(\d+(?:\.\d+)?)$/);   if(m){ const r=findByCode(m[1]); if(r) return tryPush(r,m[2]) }
  m = s0.match(/^(\S+)\s*[xX×＊*]\s*(\d+(?:\.\d+)?)$/); if(m){ const r=findByCode(m[1]); if(r) return tryPush(r,m[2]) }
  m = s0.match(/^(\S+)\s*[\.|．]\s*(\d+(?:\.\d+)?)$/);   if(m){ const r=findByCode(m[1]); if(r) return tryPush(r,m[2]) }
  m = s0.match(/^(.+?)\s+(\d+(?:\.\d+)?)$/);   if(m){ const r=findByName(m[1]); if(r) return tryPush(r,m[2]) }
  m = s0.match(/^(.+?)\s*[xX×＊*]\s*(\d+(?:\.\d+)?)$/); if(m){ const r=findByName(m[1]); if(r) return tryPush(r,m[2]) }
  m = s0.match(/^(.+?)\s*[\.|．]\s*(\d+(?:\.\d+)?)$/);   if(m){ const r=findByName(m[1]); if(r) return tryPush(r,m[2]) }
  m = s0.match(/^(\S+)\s+(.+?)\s+(\d+(?:\.\d+)?)$/); if(m){ const r=findByCode(m[1]); if(r && normNameStrict(m[2])===normNameStrict(r.品名)) return tryPush(r,m[3]) }
  m = s0.match(/^(.+?)(\d+(?:\.\d+)?)$/);
  if(m){ let r=findByCode(m[1]); if(r) return tryPush(r,m[2]); r=findByName(m[1]); if(r) return tryPush(r,m[2]) }
  let r=findByCode(s0); if(r) return tryPush(r,1)
  r=findByName(s0); if(r) return tryPush(r,1)
  return null
}
function parseOrderLines(text){
  const lines = String(text||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean)
  const ok=[], bad=[], tokens=[]
  for(const line of lines){
    const item = parseLineStrict(line)
    if(item){ ok.push(item) } else { bad.push(line); tokens.push({token: line}) }
  }
  return {ok, bad, tokens}
}

// ===== Suggestions (plain text) =====
function scoreToken(rawKey, rec){
  const keyName = normNameStrict(normalizeFullHalf(rawKey)).toUpperCase()
  const keyCode = normalizeCode(rawKey).toUpperCase().replace(/[^A-Z0-9]/g,'')
  const code = normalizeCode(rec.代碼).toUpperCase()
  const codeFlat = code.replace(/[^A-Z0-9]/g,'')
  const name = normNameStrict(rec.品名).toUpperCase()
  let s = 0
  if(!keyName && !keyCode) return 0
  if(keyCode){ if(codeFlat.startsWith(keyCode)) s += 8; else if(codeFlat.includes(keyCode)) s += 5 }
  if(keyName){ if(name.includes(keyName)) s += 4 }
  if(/^[0-9]+$/.test(keyCode) && /^[0-9]+$/.test(codeFlat)){
    if(codeFlat.startsWith(keyCode)) s += 2; else if(codeFlat.includes(keyCode)) s += 1
  }
  return s
}
function renderSuggestions(tokens){
  const box = document.getElementById('suggestBox')
  const list = document.getElementById('suggestList')
  if(!tokens || tokens.length===0){ box.style.display='none'; list.innerHTML=''; return }
  const fragments = []
  tokens.forEach(({token})=>{
    const raw = String(token||'').trim()
    if(!raw) return
    const scored = DB.map(r=>({r, score: scoreToken(raw, r)})).filter(x=>x.score>0)
    scored.sort((a,b)=> b.score - a.score)
    if(scored.length===0) return
    const top = scored.slice(0,5)
    fragments.push(`<div class="hint">「${raw}」可能是：</div>`)
    top.forEach(({r})=>{
      const code = normalizeCode(r.代碼)
      const name = r.品名 || ''
      fragments.push(`<div>・${code}　${name}</div>`)
    })
    if(scored.length>5){ fragments.push('<div class="muted">……等等</div>') }
  })
  list.innerHTML = fragments.join('')
  box.style.display = fragments.length? 'block' : 'none'
}

// ===== Helpers: eligible counting =====
function retailEligibleQty(){
  return cartItems.reduce((s,it)=>{ if(it.rec && it.rec.公價零售可折) s += (Number(it.qty)||0); return s }, 0)
}

// ===== Pricing (base + discounted) =====
function currentPercents(){
  if(MODE==='nong'){
    return { dSingle: readPercentInput('#dSingle', 75)/100, dCombo: readPercentInput('#dCombo', 75)/100 }
  }
  const few = readPercentInput('#jiuDiscFew', 80)/100
  const many = readPercentInput('#jiuDiscMany', 66)/100
  return { retailFew: few, retailMany: many }
}

function computeUnits(rec, qty, noCharge=false){
  if(noCharge) return { base:0, eff:0 }
  const type = classify(rec.代碼)
  if(MODE==='nong'){
    const {dSingle, dCombo} = currentPercents()
    const disc = (type==='單味')? dSingle : dCombo
    const base = Number(rec.批發價)
    // 公價不折（折實=批發價）
    if(rec.公價產品){
      const eff = base
      return { base, eff }
    }
    const eff = base * disc
    return { base, eff }
  }
  // 零售
  const {retailFew, retailMany} = currentPercents()
  const base = round0(rec.參考零售價)
  const eligible = retailEligibleQty()
  const d = (eligible<=2 ? retailFew : retailMany)
  const canDisc = !!rec.公價零售可折
  const eff = canDisc ? round0(base * d) : base
  return { base, eff }
}

// ===== Cart helpers & badge =====
function addItems(parsed){ cartItems = cartItems.concat(parsed.map(it => ({...it, noCharge: !!it.noCharge, seq: nextSeq++}))); onCartChanged() }
function replaceItems(parsed){ nextSeq = 0; cartItems = parsed.map(it => ({...it, noCharge: !!it.noCharge, seq: nextSeq++})); onCartChanged() }
function removeIndex(idx){ cartItems.splice(idx,1); onCartChanged() }
function clearAll(){ cartItems = []; onCartChanged() }

function counts(){
  let single=0, combo=0
  cartItems.forEach(it=>{
    const code=String(it.rec.代碼||'').toUpperCase()
    const type=classify(code)
    if(type==='複方'){
      if(!code.startsWith('FG')) combo += (Number(it.qty)||0)
    }else{ single += (Number(it.qty)||0) }
  })
  return {single, combo, total: single+combo}
}
function updateOrderBadge(){
  let text='—'
  if(MODE==='nong'){
    const ds = readPercentInput('#dSingle',75)
    const dc = readPercentInput('#dCombo',75)
    const shownS = formatFold(ds)
    const shownC = formatFold(dc)
    text = `單味 ${shownS} 折；複方 ${shownC} 折`
  }else{
    const fewPct = readPercentInput('#jiuDiscFew',80)
    const manyPct = readPercentInput('#jiuDiscMany',66)
    const shownFew = formatFold(fewPct)
    const shownMany = formatFold(manyPct)
    const elig = retailEligibleQty()
    text = `零售折扣（僅計可折產品） ≤2枝：${shownFew} 折；≥3枝：${shownMany} 折 ｜ 當前計入枝數：${elig}`
  }
  const c = counts()
  const badge = document.getElementById('orderBadge')
  if(badge) badge.textContent = `此訂單的折扣：${text} ｜ 單味 ${c.single} 枝；複方 ${c.combo} 枝；總 ${c.total} 枝`
}

function onCartChanged(){ renderTable() }
function renderTable(){
  const tb = document.querySelector('#resultTbl tbody'); if(!tb) {console.warn('tbody missing'); return;} tb.innerHTML=''

  // 表頭顯示
  const thUnit=document.getElementById('thUnit'), thDisc=document.getElementById('thDisc'), thRetail=document.getElementById('thRetail')
  if(MODE==='nong'){
    if(thUnit) thUnit.textContent = '批發價'
    if(thRetail) thRetail.style.display=''
    if(thDisc) thDisc.style.display=''
  }else{ // 零售
    if(thUnit) thUnit.textContent = '價格'
    if(thRetail) thRetail.style.display='none'
    if(thDisc) thDisc.style.display=''
  }

  const dir = sortState.asc ? 1 : -1
  const view = cartItems.map((it, i) => {
    const p = computeUnits(it.rec, it.qty, it.noCharge)
    return { __i:i, base:p.base, eff:p.eff, sub:(p.eff||0)*(Number(it.qty)||0), codeKey: normalizeCode(it.rec.代碼).toUpperCase(), seq: it.seq ?? i }
  }).sort((a,b)=>{
    if(sortState.key==='disc'){
      return dir * ((a.eff||0) - (b.eff||0))
    } else if (sortState.key==='code'){
      return dir * CODE_COLLATOR.compare(a.codeKey, b.codeKey)
    } else { // 'input'
      return dir * ((a.seq||0) - (b.seq||0))
    }
  })

  let total=0
  view.forEach(row=>{
    const idx = row.__i
    const it = cartItems[idx]
    const {rec, qty, noCharge} = it
    const base = row.base
    const eff  = row.eff
    const sub  = row.sub
    total += (sub||0)

    const showBase = (MODE==='jiu'? fmt0(base) : fmt2(base))
    const showEff  = (MODE==='jiu'? fmt0(eff)  : fmt2(eff))
    const showSub  = (MODE==='jiu'? fmt0(sub)  : fmt2(sub))

    const tr = document.createElement('tr')
    tr.innerHTML = `
      <td class="c-del"><button class="xbtn" title="刪除" data-idx="${idx}">×</button></td>
      <td class="c-code">${normalizeCode(rec.代碼)||''}</td>
      <td class="c-name" title="${rec.品名||''}">${rec.品名||''}</td>
      <td class="c-qty">
        <input class="qtyInput" data-idx="${idx}" type="number" inputmode="numeric" min="0" step="1" value="${qty}" style="width:64px;text-align:left;padding:6px 8px;border:1px solid var(--edge);border-radius:8px">
      </td>
      <td class="c-free">
        <input type="checkbox" class="freeChk" data-idx="${idx}" ${noCharge?'checked':''} title="不計費">
      </td>
      <td class="c-unit">${showBase}</td>
      ${MODE==='nong' ? `<td class="c-retail">${fmt2(Number(it.rec.參考零售價))}</td>` : ''}
      <td class="c-disc">${showEff}</td>
      <td class="c-sub right">${showSub}</td>`
    tb.appendChild(tr)
  })

  const g = document.getElementById('grandTotal'); if(g) g.textContent = (MODE==='jiu'? fmt0(total) : fmt2(total))
  const nb = document.getElementById('nongBanner'); if(nb) nb.style.display = (MODE==='nong' && total<800 && cartItems.length>0)? 'block':'none'
  updateOrderBadge()

  $$('#resultTbl .xbtn').forEach(btn=>btn.addEventListener('click',e=>{ const i=Number(e.target.getAttribute('data-idx')); removeIndex(i) }))
  $$('#resultTbl .qtyInput').forEach(inp=>{
    inp.addEventListener('input', e=>{ const i=Number(e.target.dataset.idx); const v=Number(e.target.value); cartItems[i].qty = isNaN(v)||v<0? 0 : v; const id=e.target; if(qtyTimers.has(id)) clearTimeout(qtyTimers.get(id)); qtyTimers.set(id,setTimeout(()=>{ renderTable(); qtyTimers.delete(id) },450)) })
    inp.addEventListener('change', e=>{ renderTable() })
    inp.addEventListener('blur', e=>{ renderTable() })
  })
  $$('#resultTbl .freeChk').forEach(ch=>{ ch.addEventListener('change', e=>{ const i=Number(e.target.dataset.idx); cartItems[i].noCharge = e.target.checked; renderTable() }) })
}

// ===== Quote (optimized) =====
function buildQuoteText(){
  const lines=[]
  if(MODE==='nong'){
    lines.push('已折實，每枝單價：\n')
    cartItems.forEach(it=>{
      const {rec,noCharge}=it
      const {eff}=computeUnits(rec,it.qty,noCharge)
      const note = rec.公價產品 ? '（公價無折）' : ''
      lines.push(`${rec.品名}${it.qty} ${fmt2(eff)}${note}`)
    })
  }else{ // 零售
    const {retailFew,retailMany}=currentPercents()
    const elig=retailEligibleQty()
    const pct=(elig<=2? retailFew:retailMany)*100
    lines.push(`已折實${formatFold(pct)}折，每枝單價 ：\n`)
    cartItems.forEach(it=>{
      const {rec,noCharge}=it
      const {eff}=computeUnits(rec,it.qty,noCharge)
      lines.push(`${rec.品名}${it.qty} ${fmt0(eff)}`)
    })
  }
  lines.push(`\n總共 ${document.getElementById('grandTotal')?.textContent||'$0'}`)
  return lines.join('\n')
}
function buildTranslateText(){
  const codes = cartItems.map(it=>String(normalizeCode(it.rec.代碼)||''))
  const qtys  = cartItems.map(it=>String(it.qty))
  return codes.join('\n') + '\n\n' + qtys.join('\n')
}

async function copyText(txt){
  try{
    if(navigator.clipboard && isSecure()){
      await navigator.clipboard.writeText(txt)
      toast('已複製。')
      return true
    }
  }catch(e){}
  try{
    const ta=document.createElement('textarea')
    ta.value=txt; ta.setAttribute('readonly','')
    ta.style.position='fixed'; ta.style.left='-9999px'
    document.body.appendChild(ta)
    ta.focus(); ta.select();
    const ok=document.execCommand('copy')
    document.body.removeChild(ta)
    if(ok){ toast('已複製。'); return true }
  }catch(e){}
  alert('請手動全選→複製：\n\n'+txt)
  return false
}

function handleParse(add=false){
  const ta=document.getElementById('orderInput')
  const {ok, bad, tokens} = parseOrderLines(ta? ta.value: '')
  if(add) addItems(ok); else replaceItems(ok)
  if(ta) ta.value = bad.join('\n')
  renderSuggestions(tokens)
}
document.getElementById('btnParseReplace')?.addEventListener('click', ()=>handleParse(false))
document.getElementById('btnParseAdd')?.addEventListener('click', ()=>handleParse(true))
document.getElementById('btnClearAll')?.addEventListener('click',()=>{ clearAll() })
document.getElementById('btnCopyQuote')?.addEventListener('click',()=>{ copyText(buildQuoteText()) })
document.getElementById('btnTranslate')?.addEventListener('click',()=>{ copyText(buildTranslateText()) })

const orderInputEl = document.getElementById('orderInput')
orderInputEl?.addEventListener('keydown', e=>{
  if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); handleParse(true) }
})

function bindDiscountInputs(){ ['#dSingle','#dCombo','#jiuDiscFew','#jiuDiscMany'].forEach(sel=>{
  const el=document.querySelector(sel); if(!el) return;
  el.addEventListener('input', ()=>{ renderTable() });
  el.addEventListener('change', ()=>{ renderTable() })
}) }

// ===== Sort handlers =====
document.getElementById('thCode')?.addEventListener('click', ()=>{
  sortState = { key:'code', asc: (sortState.key==='code' ? !sortState.asc : true) }
  const codeArrow=document.getElementById('codeArrow'), discArrow=document.getElementById('discArrow')
  if(codeArrow) codeArrow.textContent = sortState.key==='code' ? (sortState.asc ? '↑' : '↓') : '↕'
  if(discArrow) discArrow.textContent = '↕'
  renderTable()
})
document.getElementById('thDisc')?.addEventListener('click', ()=>{
  sortState = { key:'disc', asc: (sortState.key==='disc' ? !sortState.asc : true) }
  const discArrow=document.getElementById('discArrow'), codeArrow=document.getElementById('codeArrow')
  if(discArrow) discArrow.textContent = sortState.key==='disc' ? (sortState.asc ? '↑' : '↓') : '↕'
  if(codeArrow) codeArrow.textContent = '↕'
  renderTable()
})

function updateInputTheme(){
  const ta = document.getElementById('orderInput'); if(!ta) return
  if(MODE==='nong'){ ta.style.background='#fff5f5' }
  else if(MODE==='jiu'){ ta.style.background='#f0fff4' }
}

const rootWrap = document.querySelector('.wrap')
document.getElementById('btnCompact')?.addEventListener('click',()=>{ rootWrap?.classList.toggle('compact') })
</script>
</body>
</html>
